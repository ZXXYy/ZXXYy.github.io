---
title:      "x86 CPU工作模式及发展"
date:       2023-09-12 09:00:00
author:     zxy
math: true
categories: ["Coding", "System"]
tags: ["Architecture", "x86"]
post: false
---

实模式、保护模式、长模式

X86-64, x86, x64

I386, 8086

段管理与页管理

IA32-e, IA32...

段寄存器 es stands for extra segement, the default destination for string operations (for example MOVS or CMPS). fs and gs has no hardware-assigned uses.

| 模式     | 代表芯片    | 代表架构     | 特权等级 | 段描述符 | 寄存器位宽 | 寄存器                                    | 描述                                                         |
| -------- | ----------- | ------------ | -------- | -------- | ---------- | ----------------------------------------- | ------------------------------------------------------------ |
| 实模式   | 8086        |              | 无       | 无       | 16 bit     | AX, BX, CX, DX, DI, SI, BP                | 通用寄存器，存放地址、数据，参与运算                         |
|          |             |              |          |          |            | IP                                        | instruction pointer, 指向下一条指令地址                      |
|          |             |              |          |          |            | SP                                        | stack pointer，指向当前栈顶                                  |
|          |             |              |          |          |            | CS, DS, SS, ES                            | 段寄存器，存放一个内存段的基地址                             |
|          |             |              |          |          |            | FLAGS                                     | CPU标志寄存器，存放CPU执行运算指令产生的状态位               |
|          |             |              |          |          |            | IDTR                                      | 中断向量表的基地址                                           |
| 保护模式 | Intel 80386 | IA-32 (i386) | R0-R3    | 64 bit   | 32 bit     | EAX, EBX, ECX, EDX, EDI, ESI, EBP         | 32位通用寄存器，存放地址、数据，参与运算                     |
|          |             |              |          |          |            | EIP                                       | 32位instruction pointer, 指向下一条指令地址                  |
|          |             |              |          |          |            | ESP                                       | 32位stack pointer，指向当前栈顶                              |
|          |             |              |          |          |            | CS, DS,  SS, ES, **FS, GS**               | 16位段寄存器，存放一个内存段的描述符索引，存放的不再是基地址而是一个段selector |
|          |             |              |          |          |            | EFLAGS                                    | 32位CPU标志寄存器，存放CPU执行运算指令产生的状态位           |
|          |             |              |          |          |            | CR0, CR1, CR2, CR3                        | 32位CPU控制寄存器，控制CPU的功能控制特性                     |
|          |             |              |          |          |            | IDTR                                      | 中断向量表的基地址                                           |
|          |             |              |          |          |            | GDTR                                      | 全局段描述符表的基地址                                       |
| 长模式   |             | x86-64       | R0-R3    | 64 bit   | 64 bit     | RAX, RBX, RCX, RDX, RDI, RSI, RBP, R8-R15 | 64位通用寄存器，存放地址、数据，参与运算                     |
|          |             |              |          |          |            | RIP                                       | 64位instruction pointer, 指向下一条指令地址                  |
|          |             |              |          |          |            | RSP                                       | 64位stack pointer，指向当前栈顶                              |
|          |             |              |          |          |            | CS, DS, SS, ES, **FS, GS**                | 16位段寄存器，存放一个内存段的描述符索引，存放的不再是基地址而是一个段selector |
|          |             |              |          |          |            | RFLAGS                                    | 64位CPU标志寄存器，存放CPU执行运算指令产生的状态位           |
|          |             |              |          |          |            | CR0, CR1, CR2, CR3, CR4                   | 除了CR0仍是32位CPU控制寄存器，控制CPU的功能控制特性。其他都是64位寄存器 |



## 实模式

1978 年发行的 8086 芯片 是 X86 架构的首款芯片，它的内存管理是直接访问物理内存，这种工作方式有一个名称：**实模式**

实模式下，寄存器都是16位的，以CS为例，实际最大寻址范围实CS左移4位，也就是$2^{20}$ Bytes = 1MB。因此，在实模式下，只能够访问1MB空间的内存。

8086 的寄存器位宽是 16 位，但地址总线却有 20 位，8086 的寻址空间是 1M。但在写程序时没办法把一个地址完整地放到一个寄存器里，因为寄存器相比地址少了 4 位。

为了解决这个问题，8086 就引入了段寄存器，例如 cs、ds、es、ss 等。段寄存器中记录段基地址，通过计算可以得到物理地址。

## 保护模式

保护模式下，段寄存器仍然是16位的，但是可访问地址空间已经拓展到了32位，16位段寄存器没有办法放下32位地址。

由于32位 CPU能访问的地址空间是4GB，我们将所有段的基地址设置为0，段的界限设置为0xFFFFF,段访问的粒度G设置为1（4KB）。这样设置后，所有的段都指向了同一个（0xFFFFF + 1） * 4KB = 4GB大小的空间（地址范围0x00000000 - 0xFFFFFFFF）。

CR0.PE=1打开保护模式。

 X86 CPU在每一次上电或复位后，默认进入实模式，要进入保护模式，需要通过软件来实现

有一些处理器会一个拓展，叫做physical address extension (PAE)

## 长模式

可以从实模式直接切换到长模式，也可以从保护模式切换到长模式。

长模式下必须要开启分页



操作系统的bootstrap

BIOS， 引导扇区

## Reference

1. [OS实战笔记（3） -- X86 CPU三种工作模式（实模式，保护模式，长模式）](https://blog.csdn.net/vivo01/article/details/125752362)

2. [x86架构：实模式和保护模式](https://juejin.cn/post/7233952159662276667)
